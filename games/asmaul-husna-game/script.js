const asmaulHusnaData = [
    { name: "Ar-Rahman", meaning: "Yang Maha Pengasih", description: "Allah memiliki kasih sayang yang luas untuk seluruh makhluk-Nya di dunia." },
    { name: "Ar-Rahim", meaning: "Yang Maha Penyayang", description: "Allah memiliki kasih sayang khusus dan abadi untuk hamba-hamba beriman di akhirat." },
    { name: "Al-Malik", meaning: "Yang Maha Merajai", description: "Allah adalah Raja Penguasa mutlak atas segala sesuatu di alam semesta." },
    { name: "Al-Quddus", meaning: "Yang Maha Suci", description: "Allah Maha Suci dari segala kekurangan, aib, dan kesalahan." },
    { name: "As-Salaam", meaning: "Yang Maha Memberi Kesejahteraan", description: "Allah adalah sumber kedamaian, keselamatan, dan kesejahteraan bagi makhluk." },
    { name: "Al-Mu'min", meaning: "Yang Maha Memberi Keamanan", description: "Allah memberikan rasa aman dan ketenangan kepada hati orang-orang beriman." },
    { name: "Al-Muhaimin", meaning: "Yang Maha Pemelihara", description: "Allah memelihara, mengawasi, dan menjaga segala sesuatu di alam semesta." },
    { name: "Al-Aziz", meaning: "Yang Maha Perkasa", description: "Allah memiliki kekuatan dan kemuliaan mutlak yang tidak dapat dikalahkan." },
    { name: "Al-Jabbar", meaning: "Yang Maha Gagah", description: "Allah Maha Berkehendak untuk memaksa segala sesuatu tunduk pada perintah-Nya." },
    { name: "Al-Mutakabbir", meaning: "Yang Maha Megah", description: "Allah memiliki kebesaran dan keagungan yang tiada tara." },
    { name: "Al-Khaliq", meaning: "Yang Maha Pencipta", description: "Allah yang menciptakan segala sesuatu dari ketiadaan menjadi ada." },
    { name: "Al-Bari'", meaning: "Yang Maha Melepaskan", description: "Allah mengadakan dan membentuk makhluk dengan proporsi yang tepat." },
    { name: "Al-Musawwir", meaning: "Yang Maha Membentuk Rupa", description: "Allah memberi rupa dan karakter unik pada setiap makhluk-Nya." },
    { name: "Al-Ghaffar", meaning: "Yang Maha Pengampun", description: "Allah Maha mengampuni dosa-dosa hamba-Nya berulang kali." },
    { name: "Al-Qahhar", meaning: "Yang Maha Memaksa", description: "Allah memegang kendali penuh dan berkuasa atas segala makhluk." },
    { name: "Al-Wahhab", meaning: "Yang Maha Pemberi Karunia", description: "Allah memberi karunia terus-menerus tanpa mengharap balasan." },
    { name: "Ar-Razzaq", meaning: "Yang Maha Pemberi Rezeki", description: "Allah menjamin dan memberikan rezeki kepada seluruh makhluk hidup." },
    { name: "Al-Fattah", meaning: "Yang Maha Pembuka Rahmat", description: "Allah membuka pintu kebaikan, rahmat, dan keputusan yang adil." },
    { name: "Al-'Alim", meaning: "Yang Maha Mengetahui", description: "Allah mengetahui segala sesuatu, baik yang tampak maupun yang tersembunyi." },
    { name: "Al-Qabidh", meaning: "Yang Maha Menyempitkan", description: "Allah berhak menahan atau menyempitkan rezeki bagi siapa yang dikehendaki-Nya." },
    { name: "Al-Basit", meaning: "Yang Maha Melapangkan", description: "Allah melapangkan rezeki dan nikmat bagi hamba-hamba-Nya." },
    { name: "Al-Khafidh", meaning: "Yang Maha Merendahkan", description: "Allah merendahkan derajat orang-orang yang sombong dan ingkar." },
    { name: "Ar-Rafi'", meaning: "Yang Maha Meninggikan", description: "Allah meninggikan derajat orang-orang yang beriman dan berilmu." },
    { name: "Al-Mu'izz", meaning: "Yang Maha Memuliakan", description: "Allah memberikan kemuliaan kepada siapa saja yang dikehendaki-Nya." },
    { name: "Al-Muzil", meaning: "Yang Maha Menghinakan", description: "Allah bisa menghinakan musuh-musuh-Nya dan orang yang durhaka." },
    { name: "As-Sami'", meaning: "Yang Maha Mendengar", description: "Allah mendengar segala suara, doa, dan bisikan di seluruh alam." },
    { name: "Al-Basir", meaning: "Yang Maha Melihat", description: "Allah melihat segala sesuatu, sekecil apapun, di manapun berada." },
    { name: "Al-Hakam", meaning: "Yang Maha Menetapkan", description: "Allah adalah hakim yang menetapkan hukum dengan keadilan mutlak." },
    { name: "Al-'Adl", meaning: "Yang Maha Adil", description: "Allah Maha Adil, tidak pernah menzalimi hamba-Nya sedikitpun." },
    { name: "Al-Latif", meaning: "Yang Maha Lembut", description: "Allah Maha Halus dan Lembut dalam mengatur urusan makhluk-Nya." },
    { name: "Al-Khabir", meaning: "Yang Maha Mengenal", description: "Allah mengetahui rahasia kejadian yang paling tersembunyi sekalipun." },
    { name: "Al-Halim", meaning: "Yang Maha Penyantun", description: "Allah tidak cepat membalas dosa hamba-Nya, memberi kesempatan bertaubat." },
    { name: "Al-'Azim", meaning: "Yang Maha Agung", description: "Allah memiliki keagungan yang tidak dapat dijangkau akal manusia." },
    { name: "Al-Ghafur", meaning: "Yang Maha Pengampun", description: "Allah mengampuni dosa-dosa dan menutupi aib hamba-Nya." },
    { name: "Ash-Shakur", meaning: "Yang Maha Menghargai", description: "Allah membalas amal kebaikan hamba-Nya dengan pahala berlipat ganda." },
    { name: "Al-'Aliyy", meaning: "Yang Maha Tinggi", description: "Allah Maha Tinggi kedudukan-Nya di atas segala sesuatu." },
    { name: "Al-Kabir", meaning: "Yang Maha Besar", description: "Kebesaran Allah melampaui segala bayangan dan ukuran." },
    { name: "Al-Hafiz", meaning: "Yang Maha Memelihara", description: "Allah menjaga dan memelihara seluruh makhluk dari kerusakan." },
    { name: "Al-Muqit", meaning: "Yang Maha Pemberi Kecukupan", description: "Allah memberi makan dan mencukupi kebutuhan seluruh makhluk." },
    { name: "Al-Hasib", meaning: "Yang Maha Membuat Perhitungan", description: "Allah menghitung segala amal perbuatan manusia dengan teliti." },
    { name: "Al-Jalil", meaning: "Yang Maha Luhur", description: "Allah memiliki sifat-sifat keluhuran dan kemuliaan yang sempurna." },
    { name: "Al-Karim", meaning: "Yang Maha Pemurah", description: "Allah memberi kebaikan yang melimpah tanpa diminta." },
    { name: "Ar-Raqib", meaning: "Yang Maha Mengawasi", description: "Allah selalu mengawasi gerak-gerik dan isi hati hamba-Nya." },
    { name: "Al-Mujib", meaning: "Yang Maha Mengabulkan", description: "Allah mengabulkan doa hamba-hamba yang memohon kepada-Nya." },
    { name: "Al-Wasi'", meaning: "Yang Maha Luas", description: "Rahmat dan ilmu Allah sangat luas meliputi segala sesuatu." },
    { name: "Al-Hakim", meaning: "Yang Maha Bijaksana", description: "Segala perbuatan dan hukum Allah mengandung hikmah yang sempurna." },
    { name: "Al-Wadud", meaning: "Yang Maha Mengasihi", description: "Allah mencintai hamba-hamba-Nya yang saleh." },
    { name: "Al-Majid", meaning: "Yang Maha Mulia", description: "Allah memiliki kemuliaan dan kehormatan yang tinggi." },
    { name: "Al-Ba'ith", meaning: "Yang Maha Membangkitkan", description: "Allah membangkitkan manusia dari alam kubur pada hari kiamat." },
    { name: "Ash-Shahid", meaning: "Yang Maha Menyaksikan", description: "Allah menyaksikan segala peristiwa dan perbuatan di alam semesta." },
    { name: "Al-Haqq", meaning: "Yang Maha Benar", description: "Allah adalah Kebenaran mutlak yang tidak ada keraguan padanya." },
    { name: "Al-Wakil", meaning: "Yang Maha Memelihara", description: "Allah adalah tempat bersandar dan yang mengurusi urusan hamba-Nya." },
    { name: "Al-Qawiyy", meaning: "Yang Maha Kuat", description: "Allah memiliki kekuatan sempurna dan tidak pernah merasa lelah." },
    { name: "Al-Matin", meaning: "Yang Maha Kokoh", description: "Kekuatan Allah sangat kokoh dan tidak tergoyahkan." },
    { name: "Al-Waliyy", meaning: "Yang Maha Melindungi", description: "Allah adalah pelindung dan penolong bagi orang-orang beriman." },
    { name: "Al-Hamid", meaning: "Yang Maha Terpuji", description: "Allah berhak atas segala pujian dan sanjungan dari makhluk-Nya." },
    { name: "Al-Muhsi", meaning: "Yang Maha Menghitung", description: "Allah mengetahui jumlah segala sesuatu dengan detail." },
    { name: "Al-Mubdi'", meaning: "Yang Maha Memulai", description: "Allah yang memulai penciptaan makhluk dari ketiadaan." },
    { name: "Al-Mu'id", meaning: "Yang Maha Mengembalikan", description: "Allah yang akan mengembalikan (menghidupkan) makhluk setelah mati." },
    { name: "Al-Muhyi", meaning: "Yang Maha Menghidupkan", description: "Allah yang memberi kehidupan kepada makhluk." },
    { name: "Al-Mumit", meaning: "Yang Maha Mematikan", description: "Allah yang menetapkan kematian bagi setiap makhluk yang bernyawa." },
    { name: "Al-Hayy", meaning: "Yang Maha Hidup", description: "Allah Maha Hidup kekal abadi, tidak pernah mati atau tidur." },
    { name: "Al-Qayyum", meaning: "Yang Maha Mandiri", description: "Allah berdiri sendiri dan mengurus makhluk-Nya terus menerus." },
    { name: "Al-Wajid", meaning: "Yang Maha Menemukan", description: "Allah mendapatkan apa saja yang diinginkan-Nya, tidak ada yang luput." },
    { name: "Al-Majid", meaning: "Yang Maha Mulia", description: "Allah memiliki kemuliaan yang sempurna dan abadi." },
    { name: "Al-Wahid", meaning: "Yang Maha Tunggal", description: "Allah Maha Esa, tidak ada sekutu bagi-Nya." },
    { name: "Al-Ahad", meaning: "Yang Maha Esa", description: "Allah itu Satu, tunggal, tidak beranak dan tidak diperanakkan." },
    { name: "As-Samad", meaning: "Yang Maha Dibutuhkan", description: "Allah adalah tempat bergantung segala makhluk untuk segala kebutuhan." },
    { name: "Al-Qadir", meaning: "Yang Maha Menentukan", description: "Allah berkuasa menetapkan apa saja sesuai kehendak-Nya." },
    { name: "Al-Muqtadir", meaning: "Yang Maha Berkuasa", description: "Allah memiliki kekuasaan penuh untuk berbuat apa saja." },
    { name: "Al-Muqaddim", meaning: "Yang Maha Mendahulukan", description: "Allah mendahulukan apa dan siapa yang dikehendaki-Nya." },
    { name: "Al-Mu'akhkhir", meaning: "Yang Maha Mengakhirkan", description: "Allah menunda atau mengakhirkan apa yang dikehendaki-Nya." },
    { name: "Al-Awwal", meaning: "Yang Maha Awal", description: "Allah tidak berpermulaan, Dia ada sebelum segala sesuatu ada." },
    { name: "Al-Akhir", meaning: "Yang Maha Akhir", description: "Allah tidak berakhir, Dia tetap ada setelah segala sesuatu musnah." },
    { name: "Az-Zahir", meaning: "Yang Maha Nyata", description: "Tanda-tanda kekuasaan Allah tampak nyata di alam semesta." },
    { name: "Al-Batin", meaning: "Yang Maha Ghaib", description: "Zat Allah tidak dapat dilihat oleh mata di dunia ini." },
    { name: "Al-Wali", meaning: "Yang Maha Memerintah", description: "Allah yang menguasai dan mengurus alam semesta ini." },
    { name: "Al-Muta'ali", meaning: "Yang Maha Tinggi", description: "Allah Maha Tinggi dari segala sifat kekurangan makhluk." },
    { name: "Al-Barr", meaning: "Yang Maha Penderma", description: "Allah melimpahkan kebaikan dan kebajikan kepada hamba-Nya." },
    { name: "At-Tawwab", meaning: "Yang Maha Penerima Taubat", description: "Allah menerima taubat hamba yang kembali kepada-Nya dengan tulus." },
    { name: "Al-Muntaqim", meaning: "Yang Maha Pemberi Balasan", description: "Allah memberi hukuman yang setimpal kepada orang-orang yang durhaka." },
    { name: "Al-'Afuww", meaning: "Yang Maha Pemaaf", description: "Allah menghapus dosa dan kesalahan hamba-Nya." },
    { name: "Ar-Ra'uf", meaning: "Yang Maha Pengasuh", description: "Allah sangat belas kasih dan santun kepada hamba-Nya." },
    { name: "Malikul-Mulk", meaning: "Penguasa Kerajaan", description: "Allah pemilik mutlak kekuasaan kerajaan langit dan bumi." },
    { name: "Dzul-Jalali wal-Ikram", meaning: "Pemilik Kebesaran dan Kemuliaan", description: "Allah pemilik segala keagungan dan kemuliaan yang sempurna." },
    { name: "Al-Muqsit", meaning: "Yang Maha Pemberi Keadilan", description: "Allah bertindak adil kepada seluruh makhluk dalam keputusan-Nya." },
    { name: "Al-Jami'", meaning: "Yang Maha Mengumpulkan", description: "Allah mengumpulkan seluruh manusia pada hari kiamat." },
    { name: "Al-Ghaniyy", meaning: "Yang Maha Kaya", description: "Allah Maha Kaya, tidak membutuhkan apapun dari makhluk-Nya." },
    { name: "Al-Mughni", meaning: "Yang Maha Pemberi Kekayaan", description: "Allah memberi kekayaan dan kecukupan kepada siapa yang Dia kehendaki." },
    { name: "Al-Mani'", meaning: "Yang Maha Mencegah", description: "Allah mencegah hal-hal yang tidak diinginkan menimpa hamba-Nya." },
    { name: "Ad-Darr", meaning: "Yang Maha Pemberi Derita", description: "Allah berkuasa menimpakan bahaya atau mudharat sebagai ujian." },
    { name: "An-Nafi'", meaning: "Yang Maha Pemberi Manfaat", description: "Allah memberi manfaat besar kepada makhluk-Nya." },
    { name: "An-Nur", meaning: "Yang Maha Bercahaya", description: "Allah adalah cahaya langit dan bumi, pemberi petunjuk." },
    { name: "Al-Hadi", meaning: "Yang Maha Pemberi Petunjuk", description: "Allah memberi hidayah ke jalan yang lurus kepada hamba-Nya." },
    { name: "Al-Badi'", meaning: "Yang Maha Pencipta Keindahan", description: "Allah menciptakan alam semesta dengan indah tanpa contoh sebelumnya." },
    { name: "Al-Baqi", meaning: "Yang Maha Kekal", description: "Allah kekal abadi selamanya, tidak akan pernah binasa." },
    { name: "Al-Warith", meaning: "Yang Maha Pewaris", description: "Allah pewaris sesungguhnya saat semua makhluk musnah." },
    { name: "Ar-Rashid", meaning: "Yang Maha Pandai", description: "Allah memberi petunjuk dan bimbingan yang tepat kepada hamba-Nya." },
    { name: "As-Sabur", meaning: "Yang Maha Sabar", description: "Allah Maha Sabar, tidak tergesa-gesa menghukum hamba yang berdosa." }
];

const GAME_DURATION = 60; // Total game time in seconds (optional mode) OR per question.
// Let's go with per-question timer or total game? 
// User request: "halaman kuis dengan timer dan skor yang ditampilkan secara langsung"
// User requested: "Setiap jawaban benar akan menambah skor, sedangkan jawaban salah atau kehabisan waktu tidak menambah skor."
// This implies a per-question limit or a global limit. Let's do a simple 10 questions per game, 15 seconds per question to make it relaxed but paced.

const QUESTIONS_PER_GAME = 7;
const TIME_PER_QUESTION = 15;

let currentQuestion = {};
let acceptingAnswers = false;
let score = 0;
let questionCounter = 0;
let availableQuestions = [];
let comboCount = 0;
let wrongAnswers = [];
let timer;
let timeLeft;

// Global DOM Elements
let startScreen, quizScreen, resultScreen;
let questionText, optionsContainer;
let scoreText, timerText, progressBar;
let finalScoreText, evaluationText;
let audioBtn, feedbackArea, feedbackTitle, feedbackText, nextBtn;
let combinedDisplay;
let reviewBtn, reviewContainer, reviewList, closeReviewBtn;
let knowledgeBtn, knowledgeScreen, knowledgeList, backToMenuBtn;
let restartBtn, modeQuizBtn;

document.addEventListener('DOMContentLoaded', () => {
    // Initialize DOM Elements
    startScreen = document.getElementById('start-screen');
    quizScreen = document.getElementById('quiz-screen');
    resultScreen = document.getElementById('result-screen');
    questionText = document.getElementById('question-text');
    optionsContainer = document.getElementById('options-container');
    scoreText = document.getElementById('score');
    timerText = document.getElementById('timer');
    progressBar = document.getElementById('progress');
    finalScoreText = document.getElementById('final-score');
    evaluationText = document.getElementById('evaluation-text');
    audioBtn = document.getElementById('audio-btn');
    feedbackArea = document.getElementById('feedback-area');
    feedbackTitle = document.getElementById('feedback-title');
    feedbackText = document.getElementById('feedback-text');
    nextBtn = document.getElementById('next-btn');
    combinedDisplay = document.getElementById('combo-display');
    reviewBtn = document.getElementById('review-btn');
    reviewContainer = document.getElementById('review-container');
    reviewList = document.getElementById('review-list');
    closeReviewBtn = document.getElementById('close-review-btn');

    knowledgeBtn = document.getElementById('knowledge-btn');
    knowledgeScreen = document.getElementById('knowledge-screen');
    knowledgeList = document.getElementById('knowledge-list');
    backToMenuBtn = document.getElementById('back-to-menu-btn');

    restartBtn = document.getElementById('restart-btn');
    modeQuizBtn = document.getElementById('mode-quiz-btn');

    // Attach Listeners
    if (modeQuizBtn) modeQuizBtn.addEventListener('click', () => startGame('quiz'));

    if (knowledgeBtn) knowledgeBtn.addEventListener('click', showKnowledge);
    if (backToMenuBtn) backToMenuBtn.addEventListener('click', showMainMenu);

    if (restartBtn) restartBtn.addEventListener('click', () => startGame(gameMode));

    if (audioBtn) audioBtn.addEventListener('click', () => playAudio(currentQuestion.name));
    if (nextBtn) nextBtn.addEventListener('click', getNewQuestion);
    if (reviewBtn) reviewBtn.addEventListener('click', showReview);
    if (closeReviewBtn) closeReviewBtn.addEventListener('click', () => {
        reviewContainer.classList.add('hidden');
    });
});


function startGame(mode) {
    gameMode = mode;
    questionCounter = 0;
    score = 0;
    comboCount = 0;
    wrongAnswers = [];
    availableQuestions = [...asmaulHusnaData];
    startScreen.classList.remove('active');
    startScreen.classList.add('hidden');
    resultScreen.classList.add('hidden');
    resultScreen.classList.remove('active'); // ensure hidden
    quizScreen.classList.remove('hidden');
    quizScreen.classList.add('active');

    // Toggle Timer Display
    const timerDisplay = document.getElementById('timer').parentElement;
    if (gameMode === 'practice') {
        timerDisplay.style.visibility = 'hidden';
    } else {
        timerDisplay.style.visibility = 'visible';
    }

    getNewQuestion();
}

function getNewQuestion() {
    if (availableQuestions.length === 0 || questionCounter >= QUESTIONS_PER_GAME) {
        return endGame();
    }

    // Reset UI
    feedbackArea.classList.add('hidden');
    feedbackArea.style.display = ''; // Clear inline style
    document.getElementById('combo-display').innerText = ''; // Clear combo text
    optionsContainer.style.pointerEvents = 'auto'; // Enable clicks

    questionCounter++;
    // Update Progress Bar
    const progressPercent = (questionCounter / QUESTIONS_PER_GAME) * 100;
    progressBar.style.width = `${progressPercent}%`;

    const questionIndex = Math.floor(Math.random() * availableQuestions.length);
    currentQuestion = availableQuestions[questionIndex];
    questionText.innerText = currentQuestion.name;

    // Play Audio
    setTimeout(() => playAudio(currentQuestion.name), 500); // Small delay for better UX

    // Generate Options
    const answers = generateOptions(currentQuestion);

    optionsContainer.innerHTML = '';
    answers.forEach(answer => {
        const button = document.createElement('button');
        button.innerText = answer;
        button.classList.add('option-btn');
        button.addEventListener('click', (e) => selectAnswer(e, answer === currentQuestion.meaning));
        optionsContainer.appendChild(button);
    });

    availableQuestions.splice(questionIndex, 1);
    acceptingAnswers = true;

    if (gameMode === 'quiz') {
        startTimer();
    }
    scoreText.innerText = score;
}

function generateOptions(correctQuestion) {
    // Get 3 wrong answers
    const wrongAnswers = asmaulHusnaData
        .filter(item => item.name !== correctQuestion.name)
        .sort(() => 0.5 - Math.random()) // Shuffle
        .slice(0, 3)
        .map(item => item.meaning);

    const allAnswers = [...wrongAnswers, correctQuestion.meaning];
    return allAnswers.sort(() => 0.5 - Math.random()); // Shuffle correct answer in
}

function selectAnswer(e, isCorrect) {
    if (!acceptingAnswers) return;
    try {
        acceptingAnswers = false;
        clearInterval(timer); // Stop timer

        const selectedBtn = e.target;

        // Play Sound Safe
        try { playSound(isCorrect ? 'correct' : 'wrong'); } catch (err) { console.error("Sound Error:", err); }

        if (isCorrect) {
            selectedBtn.classList.add('correct');

            comboCount++;
            let bonus = 0;
            if (comboCount > 1) {
                bonus = (comboCount - 1) * 5;

                // Emoji Logic
                let emoji = "ðŸ”¥";
                if (comboCount >= 5) emoji = "âš¡";
                if (comboCount >= 10) emoji = "ðŸŒŸ";

                // Use global combinedDisplay if available, else get it
                const comboEl = combinedDisplay || document.getElementById('combo-display');
                if (comboEl) {
                    comboEl.innerText = `${emoji} Combo x${comboCount}! (+${bonus})`;
                    comboEl.classList.remove('hidden');
                    comboEl.classList.remove('active');
                    void comboEl.offsetWidth; // Trigger reflow
                    comboEl.classList.add('active');
                }

                try { playComboSound(); } catch (err) { console.error("Combo Sound Error:", err); }
            }

            score += (10 + bonus);
            feedbackTitle.innerText = "Benar!";
            feedbackArea.classList.remove('wrong');
        } else {
            selectedBtn.classList.add('wrong');
            comboCount = 0; // Reset combo
            wrongAnswers.push(currentQuestion); // Track wrong answer

            const comboEl = combinedDisplay || document.getElementById('combo-display');
            if (comboEl) {
                comboEl.innerText = '';
                comboEl.classList.remove('active');
            }

            feedbackTitle.innerText = "Kurang Tepat";
            feedbackArea.classList.add('wrong');

            // Highlight correct
            const buttons = optionsContainer.getElementsByTagName('button');
            for (let btn of buttons) {
                if (btn.innerText === currentQuestion.meaning) {
                    btn.classList.add('correct');
                }
            }
        }
        scoreText.innerText = score;

        // Show Explanation
        feedbackText.innerText = `${currentQuestion.name} artinya "${currentQuestion.meaning}".\n\nPenjelasan: ${currentQuestion.description}`;

        // Force display
        feedbackArea.classList.remove('hidden');
        feedbackArea.style.display = 'block'; // Inline style override just in case

        // Disable other options
        optionsContainer.style.pointerEvents = 'none';

    } catch (error) {
        console.error("Error in selectAnswer:", error);
        // Fallback: try to show feedback anyway so game isn't stuck
        if (feedbackArea) feedbackArea.classList.remove('hidden');
    }
}

function startTimer() {
    timeLeft = TIME_PER_QUESTION;
    timerText.innerText = timeLeft;
    timerText.classList.remove('timer-warning'); // Reset warning
    clearInterval(timer); // clear any existing timer

    timer = setInterval(() => {
        timeLeft--;
        timerText.innerText = timeLeft;

        // Warning triggers at 5 seconds
        if (timeLeft <= 5) {
            timerText.classList.add('timer-warning');
        }

        if (timeLeft <= 0) {
            clearInterval(timer);
            acceptingAnswers = false;

            // Time out handling
            comboCount = 0; // Reset combo

            // Track wrong answer
            wrongAnswers.push(currentQuestion);

            // playFeedbackSound(false); // This function is not defined, removed or commented out

            const buttons = optionsContainer.getElementsByTagName('button');
            for (let btn of buttons) {
                if (btn.innerText === currentQuestion.meaning) {
                    btn.classList.add('correct');
                } else {
                    btn.classList.add('wrong');
                }
            }

            // Show Feedback for Timeout
            feedbackTitle.innerText = "Waktu Habis!";
            feedbackArea.classList.add('wrong');
            feedbackText.innerText = `${currentQuestion.name} artinya "${currentQuestion.meaning}".\n\nPenjelasan: ${currentQuestion.description}`;
            feedbackArea.classList.remove('hidden');
            optionsContainer.style.pointerEvents = 'none';
        }
    }, 1000);
}

function endGame() {
    quizScreen.classList.remove('active');
    quizScreen.classList.add('hidden');
    resultScreen.classList.remove('hidden');
    resultScreen.classList.add('active');

    finalScoreText.innerText = score;

    // Evaluation Logic
    const maxScore = QUESTIONS_PER_GAME * 10;
    if (score === maxScore) {
        evaluationText.innerText = "Masya Allah! Sempurna!";
    } else if (score >= maxScore * 0.7) {
        evaluationText.innerText = "Alhamdulillah, Bagus sekali!";
    } else if (score >= maxScore * 0.4) {
        evaluationText.innerText = "Bagus, tingkatkan lagi ya!";
    } else {
        evaluationText.innerText = "Jangan menyerah, ayo belajar lagi!";
    }
}

// -- Text-to-Speech (Female Voice) --
function playAudio(text) {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);

        // Default to Indonesian for ease of finding female voice on most Windows/Android systems
        utterance.lang = 'id-ID';
        utterance.rate = 0.9;

        const voices = window.speechSynthesis.getVoices();

        // Priority: Google Indonesia -> Microsoft Zira (common US Female) -> Any Female -> Any "Google"
        const preferredVoice = voices.find(voice =>
            (voice.lang === 'id-ID' && (voice.name.includes('Google') || voice.name.includes('Female'))) ||
            (voice.name.includes('Zira')) || // Windows Default Female
            (voice.name.includes('Female')) ||
            (voice.name.includes('Wanita'))
        );

        if (preferredVoice) {
            utterance.voice = preferredVoice;
            // If we picked Zira (English), we might want to keep lang ID-ID? 
            // Actually Zira trying to read Arabic/Indonesian might sound funny but is female.
            // Be safer to stick to ID/AR female voices if possible.
        }

        console.log("Speaking with voice:", utterance.voice ? utterance.voice.name : "System Default");
        window.speechSynthesis.speak(utterance);
    } else {
        console.log("Web Speech API not supported.");
    }
}

// Ensure voices are loaded (needed for Chrome)
if ('speechSynthesis' in window) {
    window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
    };
}

// -- Sound Effects --
function playSound(type) {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (!audioCtx) return;

    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    if (type === 'correct') {
        // High pitch "Bing"
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);

        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.5);
    } else if (type === 'wrong') {
        // Low "Buzz"
        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
        oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);

        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.3);
    }
}

function playComboSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (!audioCtx) return;

    const gainNode = audioCtx.createGain();
    gainNode.connect(audioCtx.destination);
    gainNode.gain.value = 0.1;

    // Cheerfull Arpeggio: C5 -> E5 -> G5 -> C6
    const notes = [523.25, 659.25, 783.99, 1046.50];
    let time = audioCtx.currentTime;

    notes.forEach((freq, index) => {
        const osc = audioCtx.createOscillator();
        osc.type = 'triangle'; // Bright sound
        osc.frequency.value = freq;
        osc.connect(gainNode);

        osc.start(time);
        osc.stop(time + 0.15); // Short notes
        time += 0.1; // Stagger start times
    });
}

// Ensure voices are loaded (needed for Chrome)
if ('speechSynthesis' in window) {
    window.speechSynthesis.onvoiceschanged = () => {
        // Pre-load voices
        window.speechSynthesis.getVoices();
    };
}

// -- Knowledge Menu Logic --
function showKnowledge() {
    startScreen.classList.remove('active');
    startScreen.classList.add('hidden');
    knowledgeScreen.classList.remove('hidden');
    knowledgeScreen.classList.add('active');

    // Populate List
    knowledgeList.innerHTML = '';
    asmaulHusnaData.forEach(item => {
        const card = document.createElement('div');
        card.classList.add('knowledge-card');

        card.innerHTML = `
            <div class="k-name">${item.name}</div>
            <div class="k-meaning">${item.meaning}</div>
            <div class="k-desc">"${item.description}"</div>
        `;
        knowledgeList.appendChild(card);
    });
}

function showMainMenu() {
    knowledgeScreen.classList.remove('active');
    knowledgeScreen.classList.add('hidden');
    startScreen.classList.remove('hidden');
    startScreen.classList.add('active');
}

